<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ®é—–é—œä»»å‹™</title>

  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    :root {
      --font-family-main: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; /* å…¨ç«™ä¸»è¦å­—å‹ */
      --font-base: 22px;  /* å…¨ç«™æ–‡å­—åŸºæº–å¤§å°ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰ */
      --font-lg: 30px;    /* å¤§å­—ç´š */
      --font-xl: 42px;    /* ç‰¹å¤§å­—ç´š */
      --muted: #6b7280;   /* æ¬¡è¦æ–‡å­—é¡è‰²ï¼ˆç°ï¼‰ */
      --ink: #111827;     /* ä¸»è¦æ–‡å­—é¡è‰²ï¼ˆæ·±ï¼‰ */
      --image-scale: 0.9; /* â˜… åœ–ç‰‡ç¸®æ”¾æ¯”ä¾‹è¨­å®šï¼š0.9ä»£è¡¨ç¸®å°10%å¤§å°ï¼Œèª¿æ•´æ­¤æ•¸å€¼ä¾†æ”¹è®Šåœ–ç‰‡æ¯”ä¾‹ */
    }

    body {
      margin: 0;
      font-family: var(--font-family-main);
      background: linear-gradient(0deg, #ebb3a9 0%, #f5a28c 45%, #ff906e 100%); /* ğŸ¨ ä¸»èƒŒæ™¯æ¼¸å±¤ */
      color: var(--ink);
      overflow: hidden;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.15);
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative; /* âœ… è®“ HUD ä»¥ #app ç‚ºå®šä½åŸºæº–ï¼Œç¨å¾Œæœƒè¨ˆç®—è²¼åˆ°ä¸»å¡å³ä¸‹ */
    }

    #main-area {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 55vh;
      overflow-y: auto;
    }

    /* ğŸ´ ä¸»å¡ï¼ˆä¸ŠåŠéƒ¨é¢æ¿ï¼‰ */
    .main-card {
      background: linear-gradient(0deg, rgba(247,237,143,1) 0%, rgba(241,223,57,1) 71%, rgba(237,214,5,1) 100%); /* ğŸ¨ ä¸»å¡èƒŒæ™¯è‰² å¯èª¿ */
      border-radius: 24px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      text-align: center;
      width: 90vw;
      max-width: 880px;
      padding: 30px 20px;
      min-height: 380px;
      transition: all 0.6s ease;
    }
    .main-card h1 { font-size: var(--font-xl); margin: 10px 0; }
    .main-card p  { font-size: var(--font-base); color: var(--muted); }

    /* âœ… æ°¸é å­˜åœ¨çš„ç‹€æ…‹åˆ—ï¼ˆè¨Šæ¯æç¤ºæ¢ï¼‰ */
    #missionNotice {
      width: 90%;
      margin: 10px auto 14px;
      min-height: 34px;
      background: rgba(255,240,240,0.96); /* ğŸ¨ ç‹€æ…‹åˆ—èƒŒæ™¯è‰² å¯èª¿ */
      border: 2px solid #f8dada;          /* ğŸ¨ ç‹€æ…‹åˆ—æ¡†ç·šè‰² å¯èª¿ */
      border-radius: 10px;
      padding: 6px 14px;
      font-weight: 700;
      color: #111;
      font-size: 17px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .notice-show { opacity: 1 !important; }

    /* æŒ‰éˆ• */
    button {
      background-color: #ffb703; /* ğŸ¨ æŒ‰éˆ•åº•è‰² å¯èª¿ */
      border: none;
      border-radius: 10px;
      color: #111;
      font-size: var(--font-base);
      padding: 10px 25px;
      cursor: pointer;
      margin-top: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      -webkit-tap-highlight-color: transparent; /* é˜² iOS æ®˜ç•™é«˜äº® */
    }
    button:hover { background-color: #ffd166; }
    button:focus, button:focus-visible { outline: none; }

    /* ğŸŸ¨ æš±ç¨±/å¯†ç¢¼è¼¸å…¥æ¡†ï¼ˆèˆ‡ç¬¬ä¸€é—œåŒç‰ˆå‹ï¼‰ */
    #nicknameInput,
    #gatePwd {
      width: 60%;
      max-width: 280px;
      height: 40px;
      margin: 12px auto;
      display: block;
      border-radius: 10px;
      border: 2px solid #ddd;
      background-color: #f2f2f2; /* ğŸ¨ åº•è‰² å¯èª¿ */
      font-size: 16px;           /* âœ… >=16px é¿å… iOS è‡ªå‹•æ”¾å¤§ */
      text-align: center;
      outline: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1) inset;
    }
    #nicknameInput::placeholder,
    #gatePwd::placeholder { color: #999; }

    /* ç¬¬äºŒé—œï¼šæª”æ¡ˆé¸æ“‡æ¡†ï¼ˆå¥—ç”¨åŒé¢¨æ ¼ï¼‰ */
    #photoInput {
      width: 60%;
      max-width: 280px;
      margin: 12px auto;
      display: block;
      border-radius: 10px;
      border: 2px solid #ddd;
      background-color: #f2f2f2; /* ğŸ¨ æª”æ¡ˆæ¡†åº•è‰² å¯èª¿ */
      font-size: 14px;
      text-align: center;
      outline: none;
      padding: 10px;
    }

    /* === å³ä¸‹è§’ç¸½åˆ† HUD + æµ®å‹•åŠ /æ‰£åˆ†æç¤ºï¼ˆä½ç½®ç”± JS è²¼åˆ°ä¸»å¡å³ä¸‹ï¼‰ === */
    #scoreHud {
      position: absolute;                 /* âœ… ä¸æ˜¯ fixedï¼Œæœƒä»¥ #app ç‚ºåŸºæº–å†ç®—åˆ°ä¸»å¡å³ä¸‹ */
      z-index: 10000;
      background: rgba(255, 249, 207, 0.95); /* ğŸ¨ æ·¡é»ƒè‰² HUD åº•è‰² */
      border: 2px solid #f8dada;            /* ğŸ¨ HUD å¤–æ¡† */
      border-radius: 10px;
      padding: 6px 12px;
      font-weight: 800;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      user-select: none;
      pointer-events: none;
      left: 0; top: 0; /* åˆå§‹ï¼Œå°‡è¢« JS è¦†å¯« */
    }
    #scorePop {
      position: absolute;   /* âœ… è·Ÿè‘— HUD ç§»å‹•ï¼Œé¡¯ç¤ºåŠ åˆ†/æ‰£åˆ†å‹•ç•« */
      z-index: 10000;
      pointer-events: none;
      font-weight: 800;
      left: 0; top: 0;      /* åˆå§‹ï¼Œå°‡è¢« JS è¦†å¯« */
    }
    .popscore {
      opacity: 0;
      animation: popfade 1.2s ease forwards;
      margin-top: 2px;
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
      font-size: 20px; /* â† æµ®å‹•ã€Œ+15åˆ†ã€å­—ç´šï¼Œæ”¹ä½ è¦çš„å¤§å° */
    }
    .popscore.gain { color: #0b7a0b; }  /* åŠ åˆ†ï¼šç¶  */
    .popscore.loss { color: #c1121f; }  /* æ‰£åˆ†ï¼šç´… */
    @keyframes popfade {
      0%   { opacity: 0; transform: translateY(0); }
      10%  { opacity: 1; transform: translateY(-2px); }
      90%  { opacity: 1; transform: translateY(-10px); }
      100% { opacity: 0; transform: translateY(-16px); }
    }

    /* === å…¨è¢å¹•æ‹¼åœ–è¦†è“‹å±¤ï¼ˆä¸Šï¼šæ•£å¡Šå€ï¼›ä¸‹ï¼šå–®ä¸€å¤§æ¡†ï¼Œä¸ç•«æ ¼ç·šï¼‰ === */
    #puzzleContainer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45); /* ğŸ¨ æ‹¼åœ–è¦†è“‹å±¤èƒŒæ™¯ï¼ˆåŠé€æ˜é»‘ï¼‰ */
      display: none;                /* ç”± JS æ§åˆ¶é–‹é—œ */
      z-index: 9999;                /* åœ¨ HUD ä¸‹æ–¹ï¼›HUD æœƒè¢«éš±è—æ‰€ä»¥æ²’é—œä¿‚ */
      margin-top: 0;
    }
    #puzzleArea {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: min(96vw, 900px);
      height: min(86vh, 700px);
      background: #fffdf2;      /* ğŸ¨ æ‹¼åœ–æ¡†ä¸»åº•è‰² */
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display: none;            /* ç”± JS æ§åˆ¶ */
      grid-template-columns: 1fr;
      grid-template-rows: 1fr 1fr auto;
      gap: 12px;
      overflow: hidden;
    }

    /* ğŸŸ© ä¸Šæ–¹ï¼šéš¨æ©Ÿæ•£è½çš„æ‹¼åœ– */
    #puzzleTop {
      position: relative;
      /* ğŸ¨ é€™è£¡æ”¹ã€Œä¸Šæ–¹æ•£å¡Šå€ã€çš„åº•è‰²ï¼æ¡†ç·š */
      background: #d9d2e9;
      border: 2px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
    }

    /* ğŸŸ¨ ä¸‹æ–¹ï¼šå–®ä¸€å¤§æ¡†ï¼ˆä¸ç•« 3x3 ç·šï¼‰ï¼Œç”¨ä¾†å¸é™„æ‹¼åœ– */
    #puzzleBottom {
      position: relative;
      /* ğŸ¨ é€™è£¡æ”¹ã€Œä¸‹æ–¹æ¥åœ–å¤§æ¡†ã€çš„åº•è‰²ï¼æ¡†ç·šï¼ˆä¸ç•« 3x3 æ ¼ç·šï¼‰ */
      background: #d9ead3;
      border: 2px dashed #ddd;
      border-radius: 12px;
      overflow: hidden;
    }

    /* æŒ‰éˆ•å€ï¼ˆé‡ä¾†ç½®ä¸­ã€å®Œæˆåœ¨å³ï¼‰ */
    #puzzleActions {
      position: relative;
      display: flex;
      justify-content: center;  /* âœ… é‡ä¾†ç½®ä¸­ */
      align-items: center;
      min-height: 56px;
      gap: 12px;
    }
    #completePuzzleButton {
      position: absolute;
      right: 0;                 /* å®Œæˆå›ºå®šåœ¨å³å´ */
      display: none;            /* æ‹¼å¥½æ‰é¡¯ç¤º */
    }

    /* æ¯ä¸€å€‹æ‹¼åœ–å¡Šï¼ˆç”± JS æ”¾å¤§ç¸®å°ã€å®šä½ï¼‰ */
    .puzzlePiece {
      position: absolute;
      width: 100px;
      height: 100px;
      background-repeat: no-repeat;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      touch-action: none; /* æ”¯æ´ Pointer æ‹–ç§»ï¼ˆæ‰‹æŒ‡ã€æ»‘é¼ ï¼‰ */
      user-select: none;
    }
    .dragging { box-shadow: 0 6px 16px rgba(0,0,0,0.35); }
    
    /* å®Œæˆæ™‚é¡¯ç¤ºçš„æ¸…æ™°åœ–ï¼ˆè¦†è“‹åœ¨ä¸‹æ–¹æ¡†ä¸Šï¼‰ */
    #puzzleReveal {
      position: absolute;
      z-index: 5;
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
      border-radius: 12px;
      background-repeat: no-repeat;
      background-size: cover;
      display: none;
    }
  </style>
</head>

  <body>

  <!-- âœ… ç¸½åˆ† HUD èˆ‡æµ®å‹•åˆ†æ•¸æç¤ºï¼ˆæœƒé  JS è²¼åˆ°ä¸»å¡å³ä¸‹è§’ï¼‰ -->
  <div id="scoreHud">ç¸½åˆ†ï¼š0</div>
  <div id="scorePop"></div>

  <div id="app">
    <div id="main-area">
      <div class="main-card" id="mission-card">
        <h1>ğŸ•™é—–é—œä»»å‹™ğŸ•’</h1>
        <div id="missionNotice"></div>
        <p>æ­¡è¿åƒåŠ é—–é—œå°‹å¯¶ä»»å‹™ï¼Œ<br>é»æ“Šé–‹å§‹é–‹å§‹é€²è¡ŒæŒ‘æˆ°ï¼</p>
        <button onclick="nextMission()">é–‹å§‹ä»»å‹™ â–¶</button>
      </div>
    </div>

    <div id="bottom-area">
      <div id="leaderboard">
        <h2>ğŸ† æ’è¡Œæ¦œ</h2>
        <span class="hint-box">ğŸ‘ˆ å·¦æ»‘åœ°åœ–</span>
        <table>
          <thead><tr><th>åæ¬¡</th><th>æš±ç¨±</th><th>åˆ†æ•¸</th></tr></thead>
          <tbody id="rank-body"></tbody>
        </table>
      </div>
      <div id="map"></div>

      <!-- â˜… æ–°å¢ï¼šç¬¬ä¸‰é ï¼Œä¸‹åŠéƒ¨å¯å†æ»‘ä¸€æ¬¡ -->
      <div id="extra-panel">
        <h2 style="font-size:26px; margin:8px 0 12px; color:#111; text-align:center;">ğŸ“£ æ´»å‹•è³‡è¨Š</h2>
        <div class="extra-wrap" style="padding:12px 16px; font-size:18px;">
          <p>æŠ½çè¾¦æ³•ã€æ³¨æ„äº‹é …ã€åŠ ç¢¼ä»»å‹™ã€è´ŠåŠ©åå–®â€¦<br>ï¼ˆéƒ½å¯ä»¥æ›´æ”¹å–”å–”å–”ï¼‰</p>
          <ul style="line-height:1.8;margin:0 0 12px 1em;">
            <li>æŠ½çç™»è¨˜æˆªæ­¢æ™‚é–“<b>20:30</b></li>
            <li>å®Œæˆæ‰€æœ‰é—œå¡å¯åŠ ç¢¼å†æŠ½ä¸€æ¬¡</li>
            <li>æœå‹™å°ä½ç½®ï¼Œèˆå°å³å´ã€Œå…Œçè™•ã€</li>
          </ul>
        </div>
      </div>
      <!-- â˜… æ–°å¢çµæŸ -->
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- âœ… å…¨è¢å¹•æ‹¼åœ–è¦†è“‹å±¤ï¼ˆä¸Šæ•£å¡Šï¼ä¸‹å¤§æ¡†ï¼å®Œæˆæ­ç¤ºï¼‹Bannerï¼‰ -->
  <div id="puzzleContainer" style="display: none;">
    <div id="puzzleArea" style="display: none;">
      <div id="puzzleTop"></div>
      <div id="puzzleBottom"></div>
      <div id="puzzleActions">
        <button id="resetPuzzleButton" onclick="resetPuzzle()">é‡ä¾†</button>
        <button id="completePuzzleButton" onclick="completePuzzle()">å®Œæˆ</button>
      </div>
      <div id="puzzleReveal"></div>
      <div id="puzzleBanner"></div>
    </div>
  </div>

  <script>
/* ===================================================================
   ğŸ§® åˆ†æ•¸ HUDï¼šé¡¯ç¤ºã€Œç¸½åˆ†ã€èˆ‡æµ®å‹• +N / -Nï¼Œä¸¦è²¼åœ¨ä¸»å¡å³ä¸‹è§’
   =================================================================== */
let totalScore = 0;                                        /* âœ… å…¨å±€ç¸½åˆ† */
const hudEl  = document.getElementById('scoreHud');        /* HUD å®¹å™¨ */
const popEl  = document.getElementById('scorePop');        /* æµ®å‹•åˆ†æ•¸å®¹å™¨ */

/* ğŸ›ï¸ å¯èª¿åƒæ•¸ï¼šHUD å¾€ä¸Šæè·é›¢ï¼ˆå–®ä½ pxï¼‰ã€‚æƒ³å†é«˜ä¸€é»å°±æ”¹å¤§ä¸€äº›ã€‚*/
window.SCORE_HUD_OFFSET_Y = 30;

function updateScoreHUD() {
  if (hudEl) hudEl.textContent = `ç¸½åˆ†ï¼š${totalScore}`;
  queuePlaceHud(); /* å…§å®¹è®Šå‹•å¾Œé‡æ–°å®šä½ */
}

/* é¡¯ç¤ºå³ä¸‹è§’æµ®å‹• +N / -N æç¤º */
function popScore(n) {
  if (!popEl) return;
  const div = document.createElement('div');
  div.className = 'popscore ' + (n >= 0 ? 'gain' : 'loss');
  div.textContent = (n >= 0 ? '+' : '') + n + ' åˆ†';
  popEl.appendChild(div);
  setTimeout(() => div.remove(), 1300);
}

/* å°è£åŠ åˆ†ï¼ˆå«æ›´æ–° HUD èˆ‡æµ®å‹•æç¤ºï¼‰ */
function addScore(n) {
  totalScore += n;
  updateScoreHUD();
  popScore(n);
}

updateScoreHUD();

/* è®“ HUD è²¼åœ¨ä¸»å¡å³ä¸‹è§’ï¼ˆä¸¦å¯ç”¨ SCORE_HUD_OFFSET_Y å¾®èª¿ã€Œå¾€ä¸Šæã€ï¼‰ */
function placeScoreHud() {
  const app  = document.getElementById('app');
  const card = document.getElementById('mission-card');
  if (!app || !card || !hudEl || !popEl) return;

  const appRect  = app.getBoundingClientRect();
  const cardRect = card.getBoundingClientRect();

  hudEl.style.visibility = 'hidden';
  hudEl.style.left = '0px';
  hudEl.style.top  = '0px';

  const margin = 7;
  const hudRect = hudEl.getBoundingClientRect();

  /* âœ… åº§æ¨™ï¼šä¸»å¡å³ä¸‹ï¼Œä¸¦å¾€ä¸Šæ SCORE_HUD_OFFSET_Y */
  const left = Math.max(0, cardRect.right - appRect.left - hudRect.width  - margin);
  const top  = Math.max(0, cardRect.bottom - appRect.top - hudRect.height - margin - (window.SCORE_HUD_OFFSET_Y || 0));

  hudEl.style.left = left + 'px';
  hudEl.style.top  = top  + 'px';
  hudEl.style.visibility = 'visible';

  /* æµ®å‹•åŠ åˆ†é¡¯ç¤ºåœ¨ HUD ä¸Šæ–¹ä¸€é» */
  const popLeft = left + hudRect.width - 60;
  const popTop  = top - 40;
  popEl.style.left = popLeft + 'px';
  popEl.style.top  = popTop  + 'px';
}

function queuePlaceHud() {
  requestAnimationFrame(() => requestAnimationFrame(placeScoreHud));
}

/* åˆå§‹åŒ– HUD ä½ç½®è¿½è¹¤ï¼ˆä¸»å¡å…§å®¹è®Šå‹•ã€è¦–çª—æ”¹è®Šæ™‚é‡å®šä½ï¼‰ */
(function initHudPlacement(){
  const card = document.getElementById('mission-card');
  if (card && window.MutationObserver) {
    const obs = new MutationObserver(() => queuePlaceHud());
    obs.observe(card, { childList: true, subtree: true });
  }
  window.addEventListener('resize', queuePlaceHud);
  window.addEventListener('orientationchange', queuePlaceHud);
  queuePlaceHud();
})();

/* âœ… åœ¨æ‹¼åœ–æœŸé–“æš«æ™‚éš±è— HUDï¼ˆç¸½åˆ†èˆ‡æµ®å‹•æç¤ºï¼‰ */
function hideHUD() {
  if (hudEl) hudEl.style.display = 'none';
  if (popEl) popEl.style.display = 'none';
}
function showHUD() {
  if (hudEl) hudEl.style.display = 'block';
  if (popEl) popEl.style.display = 'block';
  queuePlaceHud(); /* å›ä¾†å¾Œé‡æ–°å®šä½åˆ°ä¸»å¡å³ä¸‹ */
}

/* ===================================================================
   ğŸ¯ ä»»å‹™æµç¨‹æ§åˆ¶ï¼ˆæš±ç¨± â†’ ä¸Šå‚³ â†’ é—œå¡ â†’ å¯†ç¢¼ â†’ æ¸¬é©—ï¼‰
   =================================================================== */
let step = 0;

/* ğŸ”’ å¯†ç¢¼é–˜é“æ——æ¨™ï¼ˆé€²ç¬¬å…­é—œå‰ï¼‰ */
let NEED_GATE = true;
let GATE_DONE = false;

/* ğŸ” è¨ˆåˆ†ï¼šé¿å…é‡è¤‡åŠ åˆ†çš„æ——æ¨™ */
const scoreFlags = {
  nick:  false,  /* ç¬¬1é—œï¼šæš±ç¨± 10 åˆ† */
  sign:  false,  /* ç¬¬2é—œï¼šç°½åä¸Šå‚³ 15 åˆ† */
  host:  false,  /* ç¬¬3é—œï¼šæ‰¾æ‹›å¾… 15 åˆ† */
  photo: false,  /* ç¬¬4/5é—œï¼šæ‰¾æ–°äººåˆå½± 15 åˆ† */
  puzzle:false   /* ç¬¬4/5é—œï¼šæ‹¼åœ–ï¼ˆä¾ç§’æ•¸ï¼‰ */
};
function awardOnce(key, points) {
  if (scoreFlags[key]) return false;
  scoreFlags[key] = true;
  addScore(points);
  return true;
}

const baseMissions = [
  "ğŸ’³ å®Œæˆç°½åˆ°ä¸¦è¼¸å…¥æš±ç¨±",
  "âœï¸ ä¸Šå‚³ç¾ç¾çš„ç°½åç…§ç‰‡",
  "ğŸ‘€ å°‹æ‰¾ç¸½æ‹›å¾…ç´¢å–å¯†ç¢¼",
  "ğŸ“¸ èˆ‡ç”œèœœæ–°äººä¸€èµ·åˆå½±",
  "ğŸ§© å®Œæˆæ‹¼åœ–å©šç´—ç…§æŒ‘æˆ°",
  "ğŸ’¡ æ¥å—æ–°äººå‹æƒ…å¤§è€ƒé©—"
];

/* ç¬¬ 4 / 5 é—œéš¨æ©Ÿäº’æ› */
if (Math.random() > 0.5) {
  [baseMissions[3], baseMissions[4]] = [baseMissions[4], baseMissions[3]];
}

/* ç•¶å‰é—œå¡ keyï¼ˆç”¨ä¾†åœ¨ä¸Šå‚³/æ‹¼åœ–ç­‰æµç¨‹åˆ¤æ–·è¦åŠ å“ªä¸€ç¨®åˆ†ï¼‰ */
let currentMissionKey = '';

/* ç‹€æ…‹åˆ—å·¥å…· */
function showMissionNotice(text) {
  const notice = document.getElementById("missionNotice");
  if (!notice) return;
  notice.textContent = text || "";
  notice.classList.add("notice-show");
  clearTimeout(window._noticeTimer);
  window._noticeTimer = setTimeout(() => {
    notice.classList.remove("notice-show");
    setTimeout(() => { notice.textContent = ""; }, 400);
  }, 3000);
}

function nextMission() {
  const card = document.getElementById("mission-card");

  if (step === 0) {
    /* âœ… ç¬¬ 1 é—œï¼šæš±ç¨±ï¼ˆå®Œæˆï¼‹10 åˆ†ï¼‰ */
    currentMissionKey = 'nick';
    card.innerHTML = `
      <h1>ğŸ¯ ç¬¬ 1 é—œ</h1>
      <div id="missionNotice"></div>
      <p>${baseMissions[0]}</p>
      <input type="text" id="nicknameInput" placeholder="å¡«å¯«æš±ç¨±..." />
      <button id="btnNickNext" style="background-color:#ffb703;margin-top:25px;" onclick="attemptNickNext()">ä¸‹ä¸€é—œ â–¶</button>`;
    const nickInput = document.getElementById('nicknameInput');
    nickInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') attemptNickNext(); });
    step++;
    queuePlaceHud();

  } else if (step === 1) {
    /* âœ… ç¬¬ 2 é—œï¼šç°½åä¸Šå‚³ï¼ˆå®Œæˆï¼‹15 åˆ†ï¼‰ */
    currentMissionKey = 'sign';
    card.innerHTML = `
      <h1>ğŸ¯ ç¬¬ 2 é—œ</h1>
      <div id="missionNotice"></div>
      <p>${baseMissions[1]}</p>
      <div id="photoUploadBox">
        <input type="file" id="photoInput" accept="image/*" onchange="onPhotoSelected()" />
      </div>
      <button style="background-color:#ffb703;margin-top:25px;" onclick="checkPhotoAndNext()">ä¸‹ä¸€é—œ â–¶</button>`;
    step++;
    queuePlaceHud();

  } else if (step === 2) {
    /* âœ… ç¬¬ 3 é—œï¼šæ‰¾æ‹›å¾…ï¼ˆéœ€è¼¸å…¥ã€Œ1è™Ÿæ¡Œï½80è™Ÿæ¡Œã€æ–¹å¯é€šéï¼Œå®Œæˆï¼‹15 åˆ†ï¼‰ */
    currentMissionKey = 'host';
  card.innerHTML = `
    <h1>ğŸ¯ ç¬¬ 3 é—œ</h1>
    <div id="missionNotice"></div>
    <p>${baseMissions[2]}</p>
    <input
      type="text"
      id="hostInput"
      placeholder="è«‹ç´¢å–ä¸¦è¼¸å…¥é€šéå¯†ç¢¼"
      enterkeyhint="go"
      autocapitalize="off"
      autocomplete="off"
      autocorrect="off"
      style="width:60%;max-width:280px;height:40px;margin:12px auto;
      display:block;border-radius:10px;border:2px solid #ddd;background-color:#f2f2f2;
      font-size:16px;text-align:center;outline:none;box-shadow:0 2px 5px rgba(0,0,0,0.1) inset;"/>
    <button style="background-color:#ffb703;margin-top:18px;" onclick="attemptHostNext()">ä¸‹ä¸€é—œ â–¶</button>`;
  const hostInput = document.getElementById('hostInput');
  hostInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') attemptHostNext(); });
  step++;
  queuePlaceHud();

  } else if (step === 3 || step === 4) {
    /* âœ… ç¬¬ 4 æˆ– 5 é—œï¼ˆå¯èƒ½æ˜¯åˆç…§æˆ–æ‹¼åœ–ï¼‰ */
    const isPhotoMission = /(ğŸ“¸|åˆå½±|æ‹ç…§)/.test(baseMissions[step]);
    if (isPhotoMission) {
      currentMissionKey = 'photo';  /* å®Œæˆï¼‹15 åˆ† */
      card.innerHTML = `
        <h1>ğŸ¯ ç¬¬ ${step + 1} é—œ</h1>
        <div id="missionNotice"></div>
        <p>${baseMissions[step]}</p>
        <div id="photoUploadBox">
          <input type="file" id="photoInput" accept="image/*" onchange="onPhotoSelected()" />
        </div>
        <button style="background-color:#ffb703;margin-top:25px;" onclick="checkPhotoAndNext()">ä¸‹ä¸€é—œ â–¶</button>`;
    } else {
      currentMissionKey = 'puzzle'; /* ä¾ç§’æ•¸åŠ åˆ†ï¼Œå®Œæˆæ™‚å†åŠ  */
      card.innerHTML = `
        <h1>ğŸ¯ ç¬¬ ${step + 1} é—œ</h1>
        <div id="missionNotice"></div>
        <p>${baseMissions[step]}</p>
        <button style="background-color:#ffb703;margin-top:25px;" onclick="openPuzzle()">é–‹å§‹æ‹¼åœ– â–¶</button>`;
    }
    step++;
    queuePlaceHud();

  } else if (step === 5) {
    /* ğŸ”’ é€²ç¬¬ 6 é—œï¼ˆæ¸¬é©—ï¼‰å‰ï¼šå¯†ç¢¼ 0313 */
    goToGateOrQuiz();

  } else {
    /* æœ€çµ‚å®Œæˆé  */
    currentMissionKey = '';
    card.innerHTML = `
      <h1>ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰ä»»å‹™</h1>
      <div id="missionNotice"></div>
      <p>ğŸ’«ã€€æ„Ÿè¬ä¸€èµ·è®“æ´»å‹•æ›´ç¾å¥½</p>`;
    queuePlaceHud();
  }
}

/* ç¬¬3é—œï¼šè‹¥åªéœ€è¦æŒ‰éˆ•å°±éé—œï¼Œä½¿ç”¨é€™å€‹ï¼ˆä¿ç•™ä½ åŸæœ¬ attemptHostNext() çš„é©—è­‰ç‰ˆæœ¬ï¼‰ */
function awardHostAndNext() {
  awardOnce('host', 15);
  nextMission();
}

/* ç¬¬3é—œï¼šå¿…é ˆè¼¸å…¥ã€Œ1è™Ÿæ¡Œï½80è™Ÿæ¡Œã€ï¼Œç´”æ•¸å­—æœƒè‡ªå‹•è£œä¸Šã€Œè™Ÿæ¡Œã€ */
function attemptHostNext() {
  const el  = document.getElementById('hostInput');
  const raw = (el?.value || '').trim();

  // å»ç©ºç™½
  const s = raw.replace(/\s+/g, '');

  // è‹¥åªè¼¸å…¥æ•¸å­—ï¼Œè‡ªå‹•è£œã€Œè™Ÿæ¡Œã€
  const s2 = /^\d+$/.test(s) ? (s + 'è™Ÿæ¡Œ') : s;

  // åš´æ ¼é™åˆ¶ï¼š1~9ã€10~79ã€æˆ– 80ï¼Œä¸”å¿…é ˆæ¥ã€Œè™Ÿæ¡Œã€
  const ok = /^(?:[1-9]|[1-7]\d|80)è™Ÿæ¡Œ$/.test(s2);

  if (!ok) {
    showMissionNotice("âš ï¸ åªèƒ½è¼¸å…¥ 1è™Ÿæ¡Œï½80è™Ÿæ¡Œï¼ˆä¾‹å¦‚ï¼š12è™Ÿæ¡Œï¼‰");
    return;
  }

  // å›å¡«è¦ç¯„åŒ–å­—ä¸²ï¼ˆå¯è¦å¯ä¸è¦ï¼‰
  el.value = s2;

  awardOnce('host', 15);
  nextMission();
}

/* ğŸ”’ é€²ç¬¬å…­é—œå‰çš„ç¸½å¯†ç¢¼ï¼ˆ0313ï¼‰ */
function goToGateOrQuiz() {
  const card = document.getElementById("mission-card");
  if (NEED_GATE && !GATE_DONE) {
    currentMissionKey = 'gate';
    card.innerHTML = `
      <h1>ğŸ”’ å¯†ç¢¼é©—è­‰</h1>
      <div id="missionNotice"></div>
      <p>æ™šé»æœƒå…¬ä½ˆå¯†ç¢¼é€²å…¥ç¬¬ï¼–é—œ</p>
      <input type="password" id="gatePwd" placeholder="è¼¸å…¥å¯†ç¢¼..." inputmode="numeric" maxlength="6" />
      <button id="gateBtn" style="background-color:#ffb703;margin-top:18px;" onclick="verifyGate()">ç¢ºèª â–¶</button>`;
    const gate = document.getElementById('gatePwd');
    gate.addEventListener('keydown', (e) => { if (e.key === 'Enter') verifyGate(); });
    queuePlaceHud();
  } else {
    startQuiz();
    step++;
    queuePlaceHud();
  }
}

function verifyGate() {
  const v = (document.getElementById('gatePwd')?.value || '').trim();
  if (v !== '0313') {
    showMissionNotice("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡");
    return;
  }
  GATE_DONE = true;
  showMissionNotice("âœ… å¯†ç¢¼æ­£ç¢ºï¼Œé€²å…¥ç¬¬6é—œ");
  goToGateOrQuiz();
}

/* ç¬¬ä¸€é—œï¼šæš±ç¨±å¿…å¡«ï¼ˆå®Œæˆï¼‹10 åˆ†ï¼‰ */
function attemptNickNext() {
  const nickInput = document.getElementById('nicknameInput');
  const name = (nickInput?.value || '').trim();
  if (!name) { showMissionNotice("âš ï¸ è«‹å¡«å¯«æš±ç¨±"); return; }
  awardOnce('nick', 10);
  nextMission();
}

/* ç¬¬äºŒé—œ & åˆç…§é—œï¼šæª¢æŸ¥ç…§ç‰‡æ˜¯å¦å·²é¸æ“‡ */
function checkPhotoAndNext() {
  const input = document.getElementById('photoInput');
  const file = input?.files[0];
  if (!file) { showMissionNotice("âš ï¸ è«‹å…ˆä¸Šå‚³ä¸€å¼µç…§ç‰‡å”·"); return; }
  if (currentMissionKey === 'sign')  awardOnce('sign', 15);
  if (currentMissionKey === 'photo') awardOnce('photo', 15);
  nextMission();
}

/* âœ… ä¸Šå‚³æ™‚åªåšæç¤ºï¼Œä¸è‡ªå‹•è·³é—œã€ä¸åŠ åˆ† */
function onPhotoSelected() {
  const input = document.getElementById('photoInput');
  const file = input?.files && input.files[0];
  if (file) {
    showMissionNotice("ğŸ“¸ å·²é¸æ“‡ç…§ç‰‡ï¼Œè«‹æŒ‰ã€Œä¸‹ä¸€é—œã€ç¹¼çºŒã€‚");
  } else {
    showMissionNotice("âš ï¸ å°šæœªé¸æ“‡ç…§ç‰‡å‘¢");
  }
}

/* ===================================================================
   ğŸ—ºï¸ åœ°åœ–è¨­å®šï¼ˆç°¡æ˜“å®¤å…§å¹³é¢ï¼‰
   =================================================================== */
const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -3,
  maxZoom: 4,
  zoomControl: false,
  attributionControl: true
});

const imageUrl = "assets/WL-å¹³é¢å ´åœ–-4.png";
const img = new Image();
img.src = imageUrl;

img.onload = function () {
  const w = img.width, h = img.height;
  const bounds = [[0, 0], [h, w]];
  L.imageOverlay(imageUrl, bounds).addTo(map);
  map.fitBounds(bounds);

  // âœ… é—œå¡èˆ‡ Bonus é»ä½
  const points = [
    { name: "é—œå¡ä¸€", coords: [h * 0.45, w * 0.45], color: "red" },
    { name: "é—œå¡äºŒ", coords: [h * 0.35, w * 0.70], color: "red" },
    { name: "é—œå¡ä¸‰", coords: [h * 0.55, w * 0.30], color: "red" },
    { name: "é—œå¡å››", coords: [h * 0.25, w * 0.80], color: "red" },
    { name: "é—œå¡äº”", coords: [h * 0.20, w * 0.20], color: "red" },
    { name: "é—œå¡å…­", coords: [h * 0.40, w * 0.10], color: "red" },
    { name: "ğŸ Bonus A", coords: [h * 0.55, w * 0.65], color: "gold" },
    { name: "ğŸ Bonus B", coords: [h * 0.40, w * 0.60], color: "gold" },
    { name: "ğŸ Bonus C", coords: [h * 0.75, w * 0.50], color: "gold" }
  ];

  points.forEach(p => {
    L.circleMarker(p.coords, {
      radius: 4,
      color: p.color,
      fillColor: p.color,
      fillOpacity: 0.9
    }).addTo(map).bindTooltip(p.name, { direction: "top", offset: [0, -4] });
  });

  L.control.attribution({ prefix: false })
    .addAttribution("ğŸ’ MYs Map Â© 2025")
    .addTo(map);
};

/* ä¿®æ­£æ»‘å‹•è¡çªï¼ˆæ”¯æ´é›™æŒ‡ç¸®æ”¾ã€å–®æŒ‡å·¦å³æ»‘é ï¼‰ */
map.on('touchstart', function(e){ e.preventDefault(); });
map.getContainer().addEventListener('touchmove', e => e.stopPropagation(), { passive: true });
map.getContainer().addEventListener('wheel', e => e.stopPropagation(), { passive: true });
map.touchZoom.disable();
map.dragging.disable();
let multiTouch = false;
map.getContainer().addEventListener('touchstart', e => {
  multiTouch = e.touches.length > 1;
  if (multiTouch) { map.touchZoom.enable(); map.dragging.enable(); }
  else            { map.touchZoom.disable(); map.dragging.disable(); }
});
map.getContainer().addEventListener('touchend', () => {
  multiTouch = false;
  map.touchZoom.disable();
  map.dragging.disable();
});

/* ğŸ§· å…¨åŸŸé˜²æ­¢éµç›¤å½ˆå‡ºå°è‡´ç•«é¢ä¸Šç§»ï¼ˆæ‰€æœ‰è¼¸å…¥èˆ‡ä¸Šå‚³æ¡†é©ç”¨ï¼‰ */
function preventKeyboardPushUp() {
  document.addEventListener('focusin', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
    }
  });
  document.addEventListener('focusout', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      document.body.style.position = '';
      document.body.style.width = '';
      window.scrollTo(0, 0);
    }
  });
}
preventKeyboardPushUp();
</script>
</body>
</html>
